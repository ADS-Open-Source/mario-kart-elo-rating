-------------------------
--    MLEKO  SCHEMA    --
--   ŁUKASZ MOWIŃSKI   --
--  03.2023 - ??.2023  --
-------------------------
DROP TABLE IF EXISTS PLAYERS CASCADE;
DROP TABLE IF EXISTS GAMES CASCADE;
DROP TABLE IF EXISTS GAMES_PLAYERS CASCADE;
CREATE TABLE PLAYERS
(
    UUID             UUID,
    SECRET           UUID    NOT NULL,
    NAME             VARCHAR NOT NULL,
    EMAIL            VARCHAR NOT NULL,
    ACTIVATED        BOOLEAN   DEFAULT FALSE,
    ELO              INTEGER   DEFAULT 2000,
    GAMESPLAYED      INTEGER   DEFAULT 0,
    LASTEMAILREQUEST TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT PK__PLAYERS PRIMARY KEY (UUID),
    CONSTRAINT UQ__PLAYERS__SECRET UNIQUE (SECRET),
    CONSTRAINT UQ__PLAYERS__NAME UNIQUE (NAME),
    CONSTRAINT UQ__PLAYERS__EMAIL UNIQUE (EMAIL)
);
CREATE INDEX IDX__PLAYERS__SECRET ON PLAYERS (SECRET);

CREATE TABLE GAMES
(
    ID            BIGINT GENERATED BY DEFAULT AS IDENTITY,
    REPORTED_BY   UUID      NOT NULL,
    REPORTED_TIME TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT PK__GAMES PRIMARY KEY (ID),
    CONSTRAINT FK__GAMES__PLAYERS FOREIGN KEY (REPORTED_BY) REFERENCES PLAYERS (UUID)
);

CREATE TABLE GAMES_PLAYERS
(
    GAME_ID      BIGINT  NOT NULL,
    PLAYER_UUID  UUID    NOT NULL,
    PLACE        TINYINT NOT NULL,
    PREVIOUS_ELO INTEGER,
    ELO          INTEGER,

    CONSTRAINT PK__GAMES_PLAYERS PRIMARY KEY (GAME_ID, PLAYER_UUID),
    CONSTRAINT FK__GAMES_PLAYERS__GAMES FOREIGN KEY (GAME_ID) REFERENCES GAMES (ID),
    CONSTRAINT FK__GAMES_PLAYERS__PLAYERS FOREIGN KEY (PLAYER_UUID) REFERENCES PLAYERS (UUID)
);
